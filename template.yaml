AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: MetaWebhookHandler Lambda + single API Gateway with CORS and stage control

Parameters:
  StageName:
    Type: String
    Default: prod
    AllowedValues: [preprod, prod]
    Description: API Gateway stage name to deploy (preprod or prod)
  CustomDomainName:
    Type: String
    Default: receipt-api.ukbennettinnovations.com
    Description: Custom domain for the API
  CertificateArn:
    Type: String
    Description: ACM certificate ARN for the custom domain
  VerifyToken:
    Type: String
    Default: my_super_secret_token_123
    Description: Token to verify GET requests from Meta
  CreateCustomDomain:
    Type: String
    AllowedValues: ["true", "false"]
    Default: "true"
    Description: Whether to create the custom domain in API Gateway

Globals:
  Function:
    Runtime: nodejs18.x
    Timeout: 10
    MemorySize: 128

Conditions:
  CreateCustomDomain: !Equals [!Ref CreateCustomDomain, "true"]
  # DomainName and BasePathMapping resources will only be created if this is true

Resources:
  MetaWebhookApi:
    Type: AWS::Serverless::Api
    Properties:
      Name: MetaWebhookApi
      StageName: !Ref StageName
      Cors:
        AllowOrigin: "'*'"
        AllowMethods: "'OPTIONS,GET,POST'"
        AllowHeaders: "'Content-Type,X-Amz-Date,Authorization,X-Api-Key'"

  # Conditional custom domain resources
  CustomDomainNameResource:
    Condition: CreateCustomDomain
    Type: AWS::ApiGateway::DomainName
    Properties:
      DomainName: !Ref CustomDomainName
      RegionalCertificateArn: !Ref CertificateArn
      EndpointConfiguration:
        Types:
          - REGIONAL
  
  CustomBasePathMapping:
    Condition: CreateCustomDomain
    Type: AWS::ApiGateway::BasePathMapping
    Properties:
      DomainName: !Ref CustomDomainName
      RestApiId: !Ref MetaWebhookApi
      Stage: prod
      BasePath: ''

  MetaWebhookGetHandler:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: lambdas/
      Handler: metaWebhookGetHandler.handler
      Events:
        GetWebhook:
          Type: Api
          Properties:
            RestApiId: !Ref MetaWebhookApi
            Path: /meta_webhook
            Method: GET
      Environment:
        Variables:
          VERIFY_TOKEN: !Ref VerifyToken

  MetaWebhookPostHandler:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: lambdas/
      Handler: metaWebhookPostHandler.handler
      Layers:
        - !Ref ErrorHandlerLayer
      Policies:
        - SQSSendMessagePolicy:
            QueueName: !GetAtt ImageProcessingQueue.QueueName
        - SQSSendMessagePolicy:
            QueueName: !GetAtt TextProcessingQueue.QueueName
        - Statement:
            - Effect: Allow
              Action:
                - secretsmanager:GetSecretValue
              Resource:
                Fn::Sub: arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:MetaSecrets*
        - Statement:
            - Effect: Allow
              Action:
                - dynamodb:GetItem
                - dynamodb:PutItem
              Resource: !GetAtt UsersTable.Arn
      Environment:
        Variables:
          IMAGE_PROCESSING_QUEUE_URL: !Ref ImageProcessingQueue
          TEXT_PROCESSING_QUEUE_URL: !Ref TextProcessingQueue
          META_SECRET_ID: !Ref MetaSecrets
      Events:
        PostWebhook:
          Type: Api
          Properties:
            RestApiId: !Ref MetaWebhookApi
            Path: /meta_webhook
            Method: POST
  
  ProcessReceiptWorker:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: lambdas/
      Handler: imageProcessingWorker.handler
      Layers:
        - !Ref ErrorHandlerLayer
      Runtime: nodejs18.x
      Timeout: 30
      MemorySize: 128
      Environment:
        Variables:
          META_SECRET_ID: !Ref MetaSecrets
          AZURE_SECRET_ID: !Ref AzureSecrets
          HEARTBEAT_QUEUE_URL: !Ref HeartbeatQueue
      Policies:
        - AWSLambdaBasicExecutionRole
        - SQSSendMessagePolicy:
            QueueName: !GetAtt HeartbeatQueue.QueueName
        - Statement:
            - Effect: Allow
              Action:
                - secretsmanager:GetSecretValue
              Resource:
                - Fn::Sub: arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:MetaSecrets*
                - Fn::Sub: arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:AzureSecrets*
            - Effect: Allow
              Action:
                - dynamodb:PutItem
              Resource:
                - !GetAtt ReceiptsTable.Arn
                - !GetAtt MessagesTable.Arn
            - Effect: Allow
              Action:
                - dynamodb:GetItem
              Resource:
                - !GetAtt CategoryTable.Arn
                - !GetAtt ImagesTable.Arn
      Events:
        ReceiptQueueEvent:
          Type: SQS
          Properties:
            Queue: !GetAtt ImageProcessingQueue.Arn
            BatchSize: 10
      Tags:
        App: ReceiptChecker

  
  ErrorHandlerLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: error-handler
      Description: "Layer for centralized error handling and WhatsApp notifications"
      ContentUri: layers/errorHandler
      CompatibleRuntimes:
        - nodejs18.x

  TextProcessingWorker:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: lambdas/
      Handler: textProcessingWorker.handler
      Layers:
        - !Ref ErrorHandlerLayer
      Policies:
        - AWSLambdaBasicExecutionRole
        - Statement:
            - Effect: Allow
              Action:
                - secretsmanager:GetSecretValue
              Resource:
                - Fn::Sub: arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:OpenAISecrets*
                - Fn::Sub: arn:aws:secretsmanager:${AWS::Region}:${AWS::AccountId}:secret:MetaSecrets*
        - Statement:
            - Effect: Allow
              Action:
                - dynamodb:Query
                - dynamodb:GetItem
                - dynamodb:UpdateItem
              Resource:
                - !GetAtt ReceiptsTable.Arn
                - !GetAtt UsersTable.Arn
                - !GetAtt ConversationHistoryTable.Arn
      Environment:
        Variables:
          OPENAI_SECRET_ID: !Ref OpenAISecrets
          META_SECRET_ID: !Ref MetaSecrets
      Timeout: 900
      Events:
        TextQueueEvent:
          Type: SQS
          Properties:
            Queue: !GetAtt TextProcessingQueue.Arn
            BatchSize: 10

  HeartbeatLogger:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: lambdas/
      Handler: heartbeatLogger.handler
      Runtime: nodejs18.x
      Timeout: 30
      MemorySize: 128
      Policies:
        - AWSLambdaBasicExecutionRole
      Events:
        HeartbeatQueueEvent:
          Type: SQS
          Properties:
            Queue: !GetAtt HeartbeatQueue.Arn
            BatchSize: 10
      Tags:
        App: ReceiptChecker

  ImageProcessingQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: ImageProcessingQueue
      VisibilityTimeout: 60
      Tags:
        - Key: App
          Value: ReceiptChecker

  
  TextProcessingQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: TextProcessingQueue
      VisibilityTimeout: 60
      Tags:
        - Key: App
          Value: ReceiptChecker

  # SQS queue for heartbeat delays to keep users engaged
  HeartbeatQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: HeartbeatQueue
      VisibilityTimeout: 60
      Tags:
        - Key: App
          Value: ReceiptChecker

  # DynamoDB tables for receipt processing
  MessagesTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: MessagesTable
      AttributeDefinitions:
        - AttributeName: pk
          AttributeType: S
        - AttributeName: sk
          AttributeType: S
      KeySchema:
        - AttributeName: pk
          KeyType: HASH
        - AttributeName: sk
          KeyType: RANGE
      BillingMode: PAY_PER_REQUEST
      Tags:
        - Key: App
          Value: ReceiptChecker

  ReceiptsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: ReceiptsTable
      AttributeDefinitions:
        - AttributeName: pk
          AttributeType: S
        - AttributeName: sk
          AttributeType: S
      KeySchema:
        - AttributeName: pk
          KeyType: HASH
        - AttributeName: sk
          KeyType: RANGE
      BillingMode: PAY_PER_REQUEST
      Tags:
        - Key: App
          Value: ReceiptChecker

  UsersTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: UsersTable
      AttributeDefinitions:
        - AttributeName: pk
          AttributeType: S
      KeySchema:
        - AttributeName: pk
          KeyType: HASH
      BillingMode: PAY_PER_REQUEST
      Tags:
        - Key: App
          Value: ReceiptChecker

  # DynamoDB table for conversation history
  ConversationHistoryTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: ConversationHistoryTable
      AttributeDefinitions:
        - AttributeName: pk
          AttributeType: S
        - AttributeName: sk
          AttributeType: S
      KeySchema:
        - AttributeName: pk
          KeyType: HASH
        - AttributeName: sk
          KeyType: RANGE
      BillingMode: PAY_PER_REQUEST
      Tags:
        - Key: App
          Value: ReceiptChecker

  # DynamoDB table for mapping company/shop names to spending categories
  CategoryTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: CategoryTable
      AttributeDefinitions:
        - AttributeName: companyName
          AttributeType: S
        - AttributeName: category
          AttributeType: S
      KeySchema:
        - AttributeName: companyName
          KeyType: HASH
      BillingMode: PAY_PER_REQUEST
      GlobalSecondaryIndexes:
        - IndexName: CategoryIndex
          KeySchema:
            - AttributeName: category
              KeyType: HASH
          Projection:
            ProjectionType: ALL
      Tags:
        - Key: App
          Value: ReceiptChecker

  # DynamoDB table for tracking seen image hashes (deduplication lookup)
  ImagesTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: ImagesTable
      AttributeDefinitions:
        - AttributeName: imageHash
          AttributeType: S
      KeySchema:
        - AttributeName: imageHash
          KeyType: HASH
      BillingMode: PAY_PER_REQUEST
      Tags:
        - Key: App
          Value: ReceiptChecker

  # Secrets Manager secret for WhatsApp Cloud API access token
  MetaSecrets:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: MetaSecrets
      Description: "Stores the WhatsApp Cloud API system user access token"
      SecretString: '{"access_token":"YOUR_WA_TOKEN"}'
      Tags:
        - Key: App
          Value: ReceiptChecker

  # Secrets Manager secret for Azure OCR configuration
  AzureSecrets:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: AzureSecrets
      Description: "Stores the Azure OCR endpoint and subscription key"
      SecretString: '{"ocr_endpoint":"https://xxx.cognitiveservices.azure.com","ocr_key":"abc123secret"}'
      Tags:
        - Key: App
          Value: ReceiptChecker
  # Secrets Manager secret for OpenAI API key
  OpenAISecrets:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: OpenAISecrets
      Description: "Stores the API key for OpenAI Chat Completions"
      SecretString: '{"openai_api_key":"YOUR_OPENAI_API_KEY"}'
      Tags:
        - Key: App
          Value: ReceiptChecker

Outputs:
  ApiEndpoint:
    Description: URL of the MetaWebhook API endpoint
    Value: !Sub "https://${MetaWebhookApi}.execute-api.${AWS::Region}.amazonaws.com/${StageName}/meta_webhook"
  CustomDomainName:
    Description: "Custom domain for the API"
    Value: !Ref CustomDomainName

  ImageProcessingQueueUrl:
    Description: URL of the ImageProcessingQueue SQS queue
    Value: !Ref ImageProcessingQueue
  TextProcessingQueueUrl:
    Description: URL of the TextProcessingQueue SQS queue
    Value: !Ref TextProcessingQueue
  HeartbeatQueueUrl:
    Description: URL of the HeartbeatQueue SQS queue
    Value: !Ref HeartbeatQueue